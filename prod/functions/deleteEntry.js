"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.deleteEntry = void 0;var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof")); /**
 * @author Peter Collins - https://github.com/onepetercollins
 * 
 * @fileoverview : Exports a function: deleteEntry(state, payload)
 * 
 * @function deleteEntry : For state drilling and surgical deletion of object [key: value] pairs.
 *                         This function can be used to dynamically delete infinitely nested object entries.
 *                         It takes current state and a payload object as arguments.
 *                         It returns a local function which returns updated state.
 * 
 * @param   {Object}   state The object to be mutated.
 * @param   {Object}   payload { name: String, child: Array }
 * @param   {String}   payload.name Name of the [key: value] pair to be deleted or second object in the nesting hieriarchy.
 * @param   {Array}    payload.child Array of strings pointing to the nested [key: value] pair to be deleted.
 * @returns {Function} (local function) (payload) => : The new app state, or current state if it was not altered.
 */

var deleteEntry = function deleteEntry(state, payload) {

  /**
   * @param   {Object} payload { name: String, child: Array }
   * @param   {String} payload.name Name of the [key: value] pair to be deleted or second object in the nesting hieriarchy.
   * @param   {Array}  payload.child Array of strings pointing to the nested [key: value] pair to be deleted.
   * @returns {Object} { updatedState } : The new app state, or current state if it was not altered.
   */

  return function () {var payloadInherited = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : payload;
    var currentState = JSON.parse(JSON.stringify(state));
    var updatedState = null;
    var name = payloadInherited.name,child = payloadInherited.child;
    var nameField = name;
    var children = child;
    var testArray = state ? Array.from(state) : null;
    var snapshots = [];

    if ((0, _typeof2["default"])(state) !== 'object' || state[state.length - 1] === testArray.pop() && typeof testArray.pop() !== "undefined") {
      console.error("[state] must be a valid javascript object");
      return state;
    }

    if ((0, _typeof2["default"])(children) === "object") /* check if 'children' is an empty array and nullify it */{
        if (children.length === 0 && typeof children[children.length - 1] === "undefined") {
          children = null;
        }
      }

    if (!children && !currentState.hasOwnProperty(nameField)) {
      console.error("The referenced property '".concat(nameField, "' does not exist in current state."));
      return state;
    }

    if (!children && currentState.hasOwnProperty(nameField)) {
      updatedState = {};

      if (Object.keys(currentState).length > 1) {
        for (var index = 0; index < Object.keys(currentState).length; index++) {
          if (Object.keys(currentState)[index] !== nameField) {
            updatedState[Object.keys(currentState)[index]] = Object.values(currentState)[index];
            return updatedState;
          }
        }
      } else {
        return updatedState;
      }
    } else if (children.length && currentState.hasOwnProperty(nameField)) {
      for (var _index = 0; _index < children.length; _index++) {
        if (!snapshots.length) {
          if (_index !== children.length - 1) {
            snapshots.push(currentState[nameField][children[_index]]);
          } else {
            var mutatedObject = {};

            for (var index0 = 0; index0 < Object.keys(currentState[nameField]).length; index0++) {
              if (Object.keys(currentState[nameField])[index0] !== children[children.length - 1]) {
                mutatedObject[Object.keys(currentState[nameField])[index0]] = currentState[nameField][Object.keys(currentState[nameField])[index0]];
              }

              if (index0 === Object.keys(currentState[nameField]).length - 1) {
                Object.assign(currentState, state);
                currentState[nameField] = mutatedObject;
                updatedState = currentState;
                return updatedState;
              }
            }
          }
        } else {
          if (_index === children.length - 1) {
            var _mutatedObject = {};

            for (var _index2 = 0; _index2 < Object.keys(snapshots[snapshots.length - 1]).length; _index2++) {
              if (Object.keys(snapshots[snapshots.length - 1])[_index2] !== children[children.length - 1]) {
                if (typeof snapshots[snapshots.length - 1][children[_index]] !== "undefined") {
                  _mutatedObject[Object.keys(snapshots[snapshots.length - 1])[_index2]] = snapshots[snapshots.length - 1][Object.keys(snapshots[snapshots.length - 1])[_index2]];
                } else if (typeof snapshots[snapshots.length - 1][children[_index]] === "undefined") {
                  console.log("The referenced property '".concat(children[_index], "' does not exist in current state."));
                  return state;
                }
              }

              if (_index2 === Object.keys(snapshots[snapshots.length - 1]).length - 1) {
                snapshots[snapshots.length - 1] = _mutatedObject;
              }
            }

            for (var _index3 = snapshots.length - 1; _index3 >= 0; _index3--) {
              if (_index3 < snapshots.length - 1) {
                snapshots[_index3][children[_index3 + 1]] = snapshots[_index3 + 1];
              }

              if (_index3 === 0) {
                Object.assign(currentState, state);
                currentState[nameField][children[_index3]] = snapshots[_index3];
                updatedState = currentState;
                return updatedState;
              }
            }
          } else {
            if ((0, _typeof2["default"])(snapshots[snapshots.length - 1][children[_index]]) === "object" && typeof snapshots[snapshots.length - 1][children[_index]] !== "undefined") {
              snapshots.push(snapshots[snapshots.length - 1][children[_index]]);
            } else if (typeof snapshots[snapshots.length - 1][children[_index]] === "undefined") {
              console.log("The referenced property '".concat(children[_index], "' does not exist in current state."));
              return state;
            }
          }
        }
      }
    } else {
      console.log("The referenced property '".concat(nameField, "' does not exist in current state."));
      return state;
    }
  };
};exports.deleteEntry = deleteEntry;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRlbGV0ZUVudHJ5LmpzIl0sIm5hbWVzIjpbImRlbGV0ZUVudHJ5Iiwic3RhdGUiLCJwYXlsb2FkIiwicGF5bG9hZEluaGVyaXRlZCIsImN1cnJlbnRTdGF0ZSIsIkpTT04iLCJwYXJzZSIsInN0cmluZ2lmeSIsInVwZGF0ZWRTdGF0ZSIsIm5hbWUiLCJjaGlsZCIsIm5hbWVGaWVsZCIsImNoaWxkcmVuIiwidGVzdEFycmF5IiwiQXJyYXkiLCJmcm9tIiwic25hcHNob3RzIiwibGVuZ3RoIiwicG9wIiwiY29uc29sZSIsImVycm9yIiwiaGFzT3duUHJvcGVydHkiLCJPYmplY3QiLCJrZXlzIiwiaW5kZXgiLCJ2YWx1ZXMiLCJwdXNoIiwibXV0YXRlZE9iamVjdCIsImluZGV4MCIsImFzc2lnbiIsImxvZyJdLCJtYXBwaW5ncyI6IjhRQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVRLElBQU1BLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUNDLEtBQUQsRUFBUUMsT0FBUixFQUFvQjs7QUFFNUM7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVJLFNBQU8sWUFBc0MsS0FBNUJDLGdCQUE0Qix1RUFBVEQsT0FBUztBQUN6QyxRQUFJRSxZQUFZLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXRCxJQUFJLENBQUNFLFNBQUwsQ0FBZU4sS0FBZixDQUFYLENBQW5CO0FBQ0EsUUFBSU8sWUFBWSxHQUFHLElBQW5CO0FBQ0EsUUFBTUMsSUFBTixHQUFzQk4sZ0JBQXRCLENBQU1NLElBQU4sQ0FBWUMsS0FBWixHQUFzQlAsZ0JBQXRCLENBQVlPLEtBQVo7QUFDQSxRQUFJQyxTQUFTLEdBQUdGLElBQWhCO0FBQ0EsUUFBSUcsUUFBUSxHQUFHRixLQUFmO0FBQ0EsUUFBSUcsU0FBUyxHQUFHWixLQUFLLEdBQUdhLEtBQUssQ0FBQ0MsSUFBTixDQUFXZCxLQUFYLENB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QSxPQUFPLENBQUNXLEdBQVIsb0NBQXdDbEIsUUFBUSxDQUFDWSxNQUFELENBQWhEO0FBQ0EscUJBQU92QixLQUFQO0FBQ0g7QUFDSjtBQUNKO0FBQ0o7QUFDSixLQTlETSxNQThEQTtBQUNIa0IsTUFBQUEsT0FBTyxDQUFDVyxHQUFSLG9DQUF3Q25CLFNBQXhDO0FBQ0EsYUFBT1YsS0FBUDtBQUNIO0FBQ0osR0F4R0Q7QUF5R0gsQ0FsSE8sQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBAYXV0aG9yIFBldGVyIENvbGxpbnMgLSBodHRwczovL2dpdGh1Yi5jb20vb25lcGV0ZXJjb2xsaW5zXHJcbiAqIFxyXG4gKiBAZmlsZW92ZXJ2aWV3IDogRXhwb3J0cyBhIGZ1bmN0aW9uOiBkZWxldGVFbnRyeShzdGF0ZSwgcGF5bG9hZClcclxuICogXHJcbiAqIEBmdW5jdGlvbiBkZWxldGVFbnRyeSA6IEZvciBzdGF0ZSBkcmlsbGluZyBhbmQgc3VyZ2ljYWwgZGVsZXRpb24gb2Ygb2JqZWN0IFtrZXk6IHZhbHVlXSBwYWlycy5cclxuICogICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZCB0byBkeW5hbWljYWxseSBkZWxldGUgaW5maW5pdGVseSBuZXN0ZWQgb2JqZWN0IGVudHJpZXMuXHJcbiAqICAgICAgICAgICAgICAgICAgICAgICAgIEl0IHRha2VzIGN1cnJlbnQgc3RhdGUgYW5kIGEgcGF5bG9hZCBvYmplY3QgYXMgYXJndW1lbnRzLlxyXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICBJdCByZXR1cm5zIGEgbG9jYWwgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyB1cGRhdGVkIHN0YXRlLlxyXG4gKiBcclxuICogQHBhcmFtICAge09iamVjdH0gICBzdGF0ZSBUaGUgb2JqZWN0IHRvIGJlIG11dGF0ZWQuXHJcbiAqIEBwYXJhbSAgIHtPYmplY3R9ICAgcGF5bG9hZCB7IG5hbWU6IFN0cmluZywgY2hpbGQ6IEFycmF5IH1cclxuICogQHBhcmFtICAge1N0cmluZ30gICBwYXlsb2FkLm5hbWUgTmFtZSBvZiB0aGUgW2tleTogdmFsdWVdIHBhaXIgdG8gYmUgZGVsZXRlZCBvciBzZWNvbmQgb2JqZWN0IGluIHRoZSBuZXN0aW5nIGhpZXJpYXJjaHkuXHJcbiAqIEBwYXJhbSAgIHtBcnJheX0gICAgcGF5bG9hZC5jaGlsZCBBcnJheSBvZiBzdHJpbmdzIHBvaW50aW5nIHRvIHRoZSBuZXN0ZWQgW2tleTogdmFsdWVdIHBhaXIgdG8gYmUgZGVsZXRlZC5cclxuICogQHJldHVybnMge0Z1bmN0aW9ufSAobG9jYWwgZnVuY3Rpb24pIChwYXlsb2FkKSA9PiA6IFRoZSBuZXcgYXBwIHN0YXRlLCBvciBjdXJyZW50IHN0YXRlIGlmIGl0IHdhcyBub3QgYWx0ZXJlZC5cclxuICovXHJcblxyXG4gZXhwb3J0IGNvbnN0IGRlbGV0ZUVudHJ5ID0gKHN0YXRlLCBwYXlsb2FkKSA9PiB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSBwYXlsb2FkIHsgbmFtZTogU3RyaW5nLCBjaGlsZDogQXJyYXkgfVxyXG4gICAgICogQHBhcmFtICAge1N0cmluZ30gcGF5bG9hZC5uYW1lIE5hbWUgb2YgdGhlIFtrZXk6IHZhbHVlXSBwYWlyIHRvIGJlIGRlbGV0ZWQgb3Igc2Vjb25kIG9iamVjdCBpbiB0aGUgbmVzdGluZyBoaWVyaWFyY2h5LlxyXG4gICAgICogQHBhcmFtICAge0FycmF5fSAgcGF5bG9hZC5jaGlsZCBBcnJheSBvZiBzdHJpbmdzIHBvaW50aW5nIHRvIHRoZSBuZXN0ZWQgW2tleTogdmFsdWVdIHBhaXIgdG8gYmUgZGVsZXRlZC5cclxuICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHsgdXBkYXRlZFN0YXRlIH0gOiBUaGUgbmV3IGFwcCBzdGF0ZSwgb3IgY3VycmVudCBzdGF0ZSBpZiBpdCB3YXMgbm90IGFsdGVyZWQuXHJcbiAgICAgKi9cclxuXHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHBheWxvYWRJbmhlcml0ZWQgPSBwYXlsb2FkKSB7XHJcbiAgICAgICAgbGV0IGN1cnJlbnRTdGF0ZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoc3RhdGUpKTtcclxuICAgICAgICBsZXQgdXBkYXRlZFN0YXRlID0gbnVsbDtcclxuICAgICAgICBsZXQgeyBuYW1lLCBjaGlsZCB9ID0gcGF5bG9hZEluaGVyaXRlZDtcclxuICAgICAgICBsZXQgbmFtZUZpZWxkID0gbmFtZTtcclxuICAgICAgICBsZXQgY2hpbGRyZW4gPSBjaGlsZDtcclxuICAgICAgICBsZXQgdGVzdEFycmF5ID0gc3RhdGUgPyBBcnJheS5mcm9tKHN0YXRlKSA6IG51bGxcclxuICAgICAgICBsZXQgc25hcHNob3RzID0gW107XHJcbiAgICBcclxuICAgICAgICBpZiAodHlwZW9mIHN0YXRlICE9PSAnb2JqZWN0JyB8fCAoc3RhdGVbc3RhdGUubGVuZ3RoIC0gMV0gPT09IHRlc3RBcnJheS5wb3AoKSAmJiB0eXBlb2YgdGVzdEFycmF5LnBvcCgpICE9PSBcInVuZGVmaW5lZFwiKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbc3RhdGVdIG11c3QgYmUgYSB2YWxpZCBqYXZhc2NyaXB0IG9iamVjdGApO1xyXG4gICAgICAgICAgICByZXR1cm4gc3RhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgaWYgKHR5cGVvZiBjaGlsZHJlbiA9PT0gXCJvYmplY3RcIikgLyogY2hlY2sgaWYgJ2NoaWxkcmVuJyBpcyBhbiBlbXB0eSBhcnJheSBhbmQgbnVsbGlmeSBpdCAqLyB7XHJcbiAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPT09IDAgJiYgdHlwZW9mIGNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aCAtIDFdID09PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlbiA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICBpZiAoIWNoaWxkcmVuICYmICFjdXJyZW50U3RhdGUuaGFzT3duUHJvcGVydHkobmFtZUZpZWxkKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBUaGUgcmVmZXJlbmNlZCBwcm9wZXJ0eSAnJHtuYW1lRmllbGR9JyBkb2VzIG5vdCBleGlzdCBpbiBjdXJyZW50IHN0YXRlLmApO1xyXG4gICAgICAgICAgICByZXR1cm4gc3RhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgaWYgKCFjaGlsZHJlbiAmJiBjdXJyZW50U3RhdGUuaGFzT3duUHJvcGVydHkobmFtZUZpZWxkKSkge1xyXG4gICAgICAgICAgICB1cGRhdGVkU3RhdGUgPSB7fTtcclxuICAgIFxyXG4gICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoY3VycmVudFN0YXRlKS5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgT2JqZWN0LmtleXMoY3VycmVudFN0YXRlKS5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoY3VycmVudFN0YXRlKVtpbmRleF0gIT09IG5hbWVGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkU3RhdGVbT2JqZWN0LmtleXMoY3VycmVudFN0YXRlKVtpbmRleF1dID0gT2JqZWN0LnZhbHVlcyhjdXJyZW50U3RhdGUpW2luZGV4XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRTdGF0ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZFN0YXRlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbi5sZW5ndGggJiYgY3VycmVudFN0YXRlLmhhc093blByb3BlcnR5KG5hbWVGaWVsZCkpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGNoaWxkcmVuLmxlbmd0aDsgaW5kZXgrKykge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFzbmFwc2hvdHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAoY2hpbGRyZW4ubGVuZ3RoIC0gMSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc25hcHNob3RzLnB1c2goY3VycmVudFN0YXRlW25hbWVGaWVsZF1bY2hpbGRyZW5baW5kZXhdXSlcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgbXV0YXRlZE9iamVjdCA9IHt9XHJcbiAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaW5kZXgwID0gMDsgaW5kZXgwIDwgT2JqZWN0LmtleXMoY3VycmVudFN0YXRlW25hbWVGaWVsZF0pLmxlbmd0aDsgaW5kZXgwKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhjdXJyZW50U3RhdGVbbmFtZUZpZWxkXSlbaW5kZXgwXSAhPT0gY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoIC0gMV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdXRhdGVkT2JqZWN0W09iamVjdC5rZXlzKGN1cnJlbnRTdGF0ZVtuYW1lRmllbGRdKVtpbmRleDBdXSA9IGN1cnJlbnRTdGF0ZVtuYW1lRmllbGRdW09iamVjdC5rZXlzKGN1cnJlbnRTdGF0ZVtuYW1lRmllbGRdKVtpbmRleDBdXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXgwID09PSAoT2JqZWN0LmtleXMoY3VycmVudFN0YXRlW25hbWVGaWVsZF0pLmxlbmd0aCAtIDEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihjdXJyZW50U3RhdGUsIHN0YXRlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3RhdGVbbmFtZUZpZWxkXSA9IG11dGF0ZWRPYmplY3Q7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZFN0YXRlID0gY3VycmVudFN0YXRlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVkU3RhdGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gKGNoaWxkcmVuLmxlbmd0aCAtIDEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtdXRhdGVkT2JqZWN0ID0ge31cclxuICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleDAgPSAwOyBpbmRleDAgPCBPYmplY3Qua2V5cyhzbmFwc2hvdHNbc25hcHNob3RzLmxlbmd0aCAtIDFdKS5sZW5ndGg7IGluZGV4MCsrKSB7ICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoc25hcHNob3RzW3NuYXBzaG90cy5sZW5ndGggLSAxXSlbaW5kZXgwXSAhPT0gY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoIC0gMV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNuYXBzaG90c1tzbmFwc2hvdHMubGVuZ3RoIC0gMV1bY2hpbGRyZW5baW5kZXhdXSAhPT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdXRhdGVkT2JqZWN0W09iamVjdC5rZXlzKHNuYXBzaG90c1tzbmFwc2hvdHMubGVuZ3RoIC0gMV0pW2luZGV4MF1dID0gc25hcHNob3RzW3NuYXBzaG90cy5sZW5ndGggLSAxXVtPYmplY3Qua2V5cyhzbmFwc2hvdHNbc25hcHNob3RzLmxlbmd0aCAtIDFdKVtpbmRleDBdXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNuYXBzaG90c1tzbmFwc2hvdHMubGVuZ3RoIC0gMV1bY2hpbGRyZW5baW5kZXhdXSA9PT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgVGhlIHJlZmVyZW5jZWQgcHJvcGVydHkgJyR7Y2hpbGRyZW5baW5kZXhdfScgZG9lcyBub3QgZXhpc3QgaW4gY3VycmVudCBzdGF0ZS5gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4MCA9PT0gKE9iamVjdC5rZXlzKHNuYXBzaG90c1tzbmFwc2hvdHMubGVuZ3RoIC0gMV0pLmxlbmd0aCAtIDEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc25hcHNob3RzW3NuYXBzaG90cy5sZW5ndGggLSAxXSA9IG11dGF0ZWRPYmplY3RcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4MCA9IHNuYXBzaG90cy5sZW5ndGggLSAxOyBpbmRleDAgPj0gMDsgaW5kZXgwLS0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleDAgPCAoc25hcHNob3RzLmxlbmd0aCAtIDEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc25hcHNob3RzW2luZGV4MF1bY2hpbGRyZW5baW5kZXgwICsgMV1dID0gc25hcHNob3RzW2luZGV4MCArIDFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4MCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oY3VycmVudFN0YXRlLCBzdGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0YXRlW25hbWVGaWVsZF1bY2hpbGRyZW5baW5kZXgwXV0gPSBzbmFwc2hvdHNbaW5kZXgwXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkU3RhdGUgPSBjdXJyZW50U3RhdGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRTdGF0ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc25hcHNob3RzW3NuYXBzaG90cy5sZW5ndGggLSAxXVtjaGlsZHJlbltpbmRleF1dID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBzbmFwc2hvdHNbc25hcHNob3RzLmxlbmd0aCAtIDFdW2NoaWxkcmVuW2luZGV4XV0gIT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuYXBzaG90cy5wdXNoKHNuYXBzaG90c1tzbmFwc2hvdHMubGVuZ3RoIC0gMV1bY2hpbGRyZW5baW5kZXhdXSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc25hcHNob3RzW3NuYXBzaG90cy5sZW5ndGggLSAxXVtjaGlsZHJlbltpbmRleF1dID09PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgVGhlIHJlZmVyZW5jZWQgcHJvcGVydHkgJyR7Y2hpbGRyZW5baW5kZXhdfScgZG9lcyBub3QgZXhpc3QgaW4gY3VycmVudCBzdGF0ZS5gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBUaGUgcmVmZXJlbmNlZCBwcm9wZXJ0eSAnJHtuYW1lRmllbGR9JyBkb2VzIG5vdCBleGlzdCBpbiBjdXJyZW50IHN0YXRlLmApO1xyXG4gICAgICAgICAgICByZXR1cm4gc3RhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG4iXX0= 
