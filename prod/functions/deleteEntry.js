"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.deleteEntry=void 0;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof"));/**
 * @author Peter Collins - https://github.com/onepetercollins
 * 
 * @fileoverview : Exports a function: deleteEntry(state, payload)
 * 
 * @function deleteEntry : For state drilling and surgical deletion of object [key: value] pairs.
 *                         This function can be used to dynamically delete infinitely nested object entries.
 *                         It takes current state and a payload object as arguments.
 *                         It returns a local function which returns updated state.
 * 
 * @param   {Object}   state The object to be mutated.
 * @param   {Object}   payload { name: String, child: Array }
 * @param   {String}   payload.name Name of the [key: value] pair to be deleted or second object in the nesting hieriarchy.
 * @param   {Array}    payload.child Array of strings pointing to the nested [key: value] pair to be deleted.
 * @returns {Function} (local function) (payload) => : The new app state, or current state if it was not altered.
 */

var deleteEntry=function deleteEntry(state,payload){

/**
     * @param   {Object} payload { name: String, child: Array }
     * @param   {String} payload.name Name of the [key: value] pair to be deleted or second object in the nesting hieriarchy.
     * @param   {Array}  payload.child Array of strings pointing to the nested [key: value] pair to be deleted.
     * @returns {Object} { updatedState } : The new app state, or current state if it was not altered.
     */

return function(){var payloadInherited=arguments.length>0&&arguments[0]!==undefined?arguments[0]:payload;
var currentState=JSON.parse(JSON.stringify(state));
var updatedState=null;
var name=payloadInherited.name,child=payloadInherited.child;
var nameField=name;
var children=child;
var testArray=state?Array.from(state):null;
var snapshots=[];

if((0,_typeof2.default)(state)!=='object'||state[state.length-1]===testArray.pop()&&typeof testArray.pop()!=="undefined"){
console.error("[state] must be a valid javascript object");
return state;
}

if((0,_typeof2.default)(children)==="object")/* check if 'children' is an empty array and nullify it */{
if(children.length===0&&typeof children[children.length-1]==="undefined"){
children=null;
}
}

if(!children&&!currentState.hasOwnProperty(nameField)){
console.error("The referenced property '".concat(nameField,"' does not exist in current state."));
return state;
}

if(!children&&currentState.hasOwnProperty(nameField)){
updatedState={};

if(Object.keys(currentState).length>1){
for(var index=0;index<Object.keys(currentState).length;index++){
if(Object.keys(currentState)[index]!==nameField){
updatedState[Object.keys(currentState)[index]]=Object.values(currentState)[index];
return updatedState;
}
}
}else{
return updatedState;
}
}else if(children.length&&currentState.hasOwnProperty(nameField)){
for(var _index=0;_index<children.length;_index++){
if(!snapshots.length){
if(_index!==children.length-1){
snapshots.push(currentState[nameField][children[_index]]);
}else{
var mutatedObject={};

for(var index0=0;index0<Object.keys(currentState[nameField]).length;index0++){
if(Object.keys(currentState[nameField])[index0]!==children[children.length-1]){
mutatedObject[Object.keys(currentState[nameField])[index0]]=currentState[nameField][Object.keys(currentState[nameField])[index0]];
}

if(index0===Object.keys(currentState[nameField]).length-1){
Object.assign(currentState,state);
currentState[nameField]=mutatedObject;
updatedState=currentState;
return updatedState;
}
}
}
}else{
if(_index===children.length-1){
var _mutatedObject={};

for(var _index2=0;_index2<Object.keys(snapshots[snapshots.length-1]).length;_index2++){
if(Object.keys(snapshots[snapshots.length-1])[_index2]!==children[children.length-1]){
if(typeof snapshots[snapshots.length-1][children[_index]]!=="undefined"){
_mutatedObject[Object.keys(snapshots[snapshots.length-1])[_index2]]=snapshots[snapshots.length-1][Object.keys(snapshots[snapshots.length-1])[_index2]];
}else if(typeof snapshots[snapshots.length-1][children[_index]]==="undefined"){
console.log("The referenced property '".concat(children[_index],"' does not exist in current state."));
return state;
}
}

if(_index2===Object.keys(snapshots[snapshots.length-1]).length-1){
snapshots[snapshots.length-1]=_mutatedObject;
}
}

for(var _index3=snapshots.length-1;_index3>=0;_index3--){
if(_index3<snapshots.length-1){
snapshots[_index3][children[_index3+1]]=snapshots[_index3+1];
}

if(_index3===0){
Object.assign(currentState,state);
currentState[nameField][children[_index3]]=snapshots[_index3];
updatedState=currentState;
return updatedState;
}
}
}else{
if((0,_typeof2.default)(snapshots[snapshots.length-1][children[_index]])==="object"&&typeof snapshots[snapshots.length-1][children[_index]]!=="undefined"){
snapshots.push(snapshots[snapshots.length-1][children[_index]]);
}else if(typeof snapshots[snapshots.length-1][children[_index]]==="undefined"){
console.log("The referenced property '".concat(children[_index],"' does not exist in current state."));
return state;
}
}
}
}
}else{
console.log("The referenced property '".concat(nameField,"' does not exist in current state."));
return state;
}
};
};exports.deleteEntry=deleteEntry;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRlbGV0ZUVudHJ5LmpzIl0sIm5hbWVzIjpbImRlbGV0ZUVudHJ5Iiwic3RhdGUiLCJwYXlsb2FkIiwicGF5bG9hZEluaGVyaXRlZCIsImN1cnJlbnRTdGF0ZSIsIkpTT04iLCJwYXJzZSIsInN0cmluZ2lmeSIsInVwZGF0ZWRTdGF0ZSIsIm5hbWUiLCJjaGlsZCIsIm5hbWVGaWVsZCIsImNoaWxkcmVuIiwidGVzdEFycmF5IiwiQXJyYXkiLCJmcm9tIiwic25hcHNob3RzIiwibGVuZ3RoIiwicG9wIiwiY29uc29sZSIsImVycm9yIiwiaGFzT3duUHJvcGVydHkiLCJPYmplY3QiLCJrZXlzIiwiaW5kZXgiLCJ2YWx1ZXMiLCJwdXNoIiwibXV0YXRlZE9iamVjdCIsImluZGV4MCIsImFzc2lnbiIsImxvZyJdLCJtYXBwaW5ncyI6ImtRQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVRLEdBQU1BLENBQUFBLFdBQVcsQ0FBRyxRQUFkQSxDQUFBQSxXQUFjLENBQUNDLEtBQUQsQ0FBUUMsT0FBUixDQUFvQjs7QUFFNUM7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVJLE1BQU8sV0FBc0MsSUFBNUJDLENBQUFBLGdCQUE0QiwyREFBVEQsT0FBUztBQUN6QyxHQUFJRSxDQUFBQSxZQUFZLENBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXRCxJQUFJLENBQUNFLFNBQUwsQ0FBZU4sS0FBZixDQUFYLENBQW5CO0FBQ0EsR0FBSU8sQ0FBQUEsWUFBWSxDQUFHLElBQW5CO0FBQ0EsR0FBTUMsQ0FBQUEsSUFBTixDQUFzQk4sZ0JBQXRCLENBQU1NLElBQU4sQ0FBWUMsS0FBWixDQUFzQlAsZ0JBQXRCLENBQVlPLEtBQVo7QUFDQSxHQUFJQyxDQUFBQSxTQUFTLENBQUdGLElBQWhCO0FBQ0EsR0FBSUcsQ0FBQUEsUUFBUSxDQUFHRixLQUFmO0FBQ0EsR0FBSUcsQ0FB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QUQsQ0FBeEMsQ0FBUCxHQUE0RCxXQUFoRSxDQUE2RTtBQUNoRkwsT0FBTyxDQUFDVyxHQUFSLG9DQUF3Q2xCLFFBQVEsQ0FBQ1ksTUFBRCxDQUFoRDtBQUNBLE1BQU92QixDQUFBQSxLQUFQO0FBQ0g7QUFDSjtBQUNKO0FBQ0o7QUFDSixDQTlETSxJQThEQTtBQUNIa0IsT0FBTyxDQUFDVyxHQUFSLG9DQUF3Q25CLFNBQXhDO0FBQ0EsTUFBT1YsQ0FBQUEsS0FBUDtBQUNIO0FBQ0osQ0F4R0Q7QUF5R0gsQ0FsSE8sQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBAYXV0aG9yIFBldGVyIENvbGxpbnMgLSBodHRwczovL2dpdGh1Yi5jb20vb25lcGV0ZXJjb2xsaW5zXHJcbiAqIFxyXG4gKiBAZmlsZW92ZXJ2aWV3IDogRXhwb3J0cyBhIGZ1bmN0aW9uOiBkZWxldGVFbnRyeShzdGF0ZSwgcGF5bG9hZClcclxuICogXHJcbiAqIEBmdW5jdGlvbiBkZWxldGVFbnRyeSA6IEZvciBzdGF0ZSBkcmlsbGluZyBhbmQgc3VyZ2ljYWwgZGVsZXRpb24gb2Ygb2JqZWN0IFtrZXk6IHZhbHVlXSBwYWlycy5cclxuICogICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZCB0byBkeW5hbWljYWxseSBkZWxldGUgaW5maW5pdGVseSBuZXN0ZWQgb2JqZWN0IGVudHJpZXMuXHJcbiAqICAgICAgICAgICAgICAgICAgICAgICAgIEl0IHRha2VzIGN1cnJlbnQgc3RhdGUgYW5kIGEgcGF5bG9hZCBvYmplY3QgYXMgYXJndW1lbnRzLlxyXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICBJdCByZXR1cm5zIGEgbG9jYWwgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyB1cGRhdGVkIHN0YXRlLlxyXG4gKiBcclxuICogQHBhcmFtICAge09iamVjdH0gICBzdGF0ZSBUaGUgb2JqZWN0IHRvIGJlIG11dGF0ZWQuXHJcbiAqIEBwYXJhbSAgIHtPYmplY3R9ICAgcGF5bG9hZCB7IG5hbWU6IFN0cmluZywgY2hpbGQ6IEFycmF5IH1cclxuICogQHBhcmFtICAge1N0cmluZ30gICBwYXlsb2FkLm5hbWUgTmFtZSBvZiB0aGUgW2tleTogdmFsdWVdIHBhaXIgdG8gYmUgZGVsZXRlZCBvciBzZWNvbmQgb2JqZWN0IGluIHRoZSBuZXN0aW5nIGhpZXJpYXJjaHkuXHJcbiAqIEBwYXJhbSAgIHtBcnJheX0gICAgcGF5bG9hZC5jaGlsZCBBcnJheSBvZiBzdHJpbmdzIHBvaW50aW5nIHRvIHRoZSBuZXN0ZWQgW2tleTogdmFsdWVdIHBhaXIgdG8gYmUgZGVsZXRlZC5cclxuICogQHJldHVybnMge0Z1bmN0aW9ufSAobG9jYWwgZnVuY3Rpb24pIChwYXlsb2FkKSA9PiA6IFRoZSBuZXcgYXBwIHN0YXRlLCBvciBjdXJyZW50IHN0YXRlIGlmIGl0IHdhcyBub3QgYWx0ZXJlZC5cclxuICovXHJcblxyXG4gZXhwb3J0IGNvbnN0IGRlbGV0ZUVudHJ5ID0gKHN0YXRlLCBwYXlsb2FkKSA9PiB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSBwYXlsb2FkIHsgbmFtZTogU3RyaW5nLCBjaGlsZDogQXJyYXkgfVxyXG4gICAgICogQHBhcmFtICAge1N0cmluZ30gcGF5bG9hZC5uYW1lIE5hbWUgb2YgdGhlIFtrZXk6IHZhbHVlXSBwYWlyIHRvIGJlIGRlbGV0ZWQgb3Igc2Vjb25kIG9iamVjdCBpbiB0aGUgbmVzdGluZyBoaWVyaWFyY2h5LlxyXG4gICAgICogQHBhcmFtICAge0FycmF5fSAgcGF5bG9hZC5jaGlsZCBBcnJheSBvZiBzdHJpbmdzIHBvaW50aW5nIHRvIHRoZSBuZXN0ZWQgW2tleTogdmFsdWVdIHBhaXIgdG8gYmUgZGVsZXRlZC5cclxuICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHsgdXBkYXRlZFN0YXRlIH0gOiBUaGUgbmV3IGFwcCBzdGF0ZSwgb3IgY3VycmVudCBzdGF0ZSBpZiBpdCB3YXMgbm90IGFsdGVyZWQuXHJcbiAgICAgKi9cclxuXHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHBheWxvYWRJbmhlcml0ZWQgPSBwYXlsb2FkKSB7XHJcbiAgICAgICAgbGV0IGN1cnJlbnRTdGF0ZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoc3RhdGUpKTtcclxuICAgICAgICBsZXQgdXBkYXRlZFN0YXRlID0gbnVsbDtcclxuICAgICAgICBsZXQgeyBuYW1lLCBjaGlsZCB9ID0gcGF5bG9hZEluaGVyaXRlZDtcclxuICAgICAgICBsZXQgbmFtZUZpZWxkID0gbmFtZTtcclxuICAgICAgICBsZXQgY2hpbGRyZW4gPSBjaGlsZDtcclxuICAgICAgICBsZXQgdGVzdEFycmF5ID0gc3RhdGUgPyBBcnJheS5mcm9tKHN0YXRlKSA6IG51bGxcclxuICAgICAgICBsZXQgc25hcHNob3RzID0gW107XHJcbiAgICBcclxuICAgICAgICBpZiAodHlwZW9mIHN0YXRlICE9PSAnb2JqZWN0JyB8fCAoc3RhdGVbc3RhdGUubGVuZ3RoIC0gMV0gPT09IHRlc3RBcnJheS5wb3AoKSAmJiB0eXBlb2YgdGVzdEFycmF5LnBvcCgpICE9PSBcInVuZGVmaW5lZFwiKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbc3RhdGVdIG11c3QgYmUgYSB2YWxpZCBqYXZhc2NyaXB0IG9iamVjdGApO1xyXG4gICAgICAgICAgICByZXR1cm4gc3RhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgaWYgKHR5cGVvZiBjaGlsZHJlbiA9PT0gXCJvYmplY3RcIikgLyogY2hlY2sgaWYgJ2NoaWxkcmVuJyBpcyBhbiBlbXB0eSBhcnJheSBhbmQgbnVsbGlmeSBpdCAqLyB7XHJcbiAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPT09IDAgJiYgdHlwZW9mIGNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aCAtIDFdID09PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlbiA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICBpZiAoIWNoaWxkcmVuICYmICFjdXJyZW50U3RhdGUuaGFzT3duUHJvcGVydHkobmFtZUZpZWxkKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBUaGUgcmVmZXJlbmNlZCBwcm9wZXJ0eSAnJHtuYW1lRmllbGR9JyBkb2VzIG5vdCBleGlzdCBpbiBjdXJyZW50IHN0YXRlLmApO1xyXG4gICAgICAgICAgICByZXR1cm4gc3RhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgaWYgKCFjaGlsZHJlbiAmJiBjdXJyZW50U3RhdGUuaGFzT3duUHJvcGVydHkobmFtZUZpZWxkKSkge1xyXG4gICAgICAgICAgICB1cGRhdGVkU3RhdGUgPSB7fTtcclxuICAgIFxyXG4gICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoY3VycmVudFN0YXRlKS5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgT2JqZWN0LmtleXMoY3VycmVudFN0YXRlKS5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoY3VycmVudFN0YXRlKVtpbmRleF0gIT09IG5hbWVGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkU3RhdGVbT2JqZWN0LmtleXMoY3VycmVudFN0YXRlKVtpbmRleF1dID0gT2JqZWN0LnZhbHVlcyhjdXJyZW50U3RhdGUpW2luZGV4XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRTdGF0ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZFN0YXRlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbi5sZW5ndGggJiYgY3VycmVudFN0YXRlLmhhc093blByb3BlcnR5KG5hbWVGaWVsZCkpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGNoaWxkcmVuLmxlbmd0aDsgaW5kZXgrKykge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFzbmFwc2hvdHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAoY2hpbGRyZW4ubGVuZ3RoIC0gMSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc25hcHNob3RzLnB1c2goY3VycmVudFN0YXRlW25hbWVGaWVsZF1bY2hpbGRyZW5baW5kZXhdXSlcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgbXV0YXRlZE9iamVjdCA9IHt9XHJcbiAgICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaW5kZXgwID0gMDsgaW5kZXgwIDwgT2JqZWN0LmtleXMoY3VycmVudFN0YXRlW25hbWVGaWVsZF0pLmxlbmd0aDsgaW5kZXgwKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhjdXJyZW50U3RhdGVbbmFtZUZpZWxkXSlbaW5kZXgwXSAhPT0gY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoIC0gMV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdXRhdGVkT2JqZWN0W09iamVjdC5rZXlzKGN1cnJlbnRTdGF0ZVtuYW1lRmllbGRdKVtpbmRleDBdXSA9IGN1cnJlbnRTdGF0ZVtuYW1lRmllbGRdW09iamVjdC5rZXlzKGN1cnJlbnRTdGF0ZVtuYW1lRmllbGRdKVtpbmRleDBdXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXgwID09PSAoT2JqZWN0LmtleXMoY3VycmVudFN0YXRlW25hbWVGaWVsZF0pLmxlbmd0aCAtIDEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihjdXJyZW50U3RhdGUsIHN0YXRlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3RhdGVbbmFtZUZpZWxkXSA9IG11dGF0ZWRPYmplY3Q7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZFN0YXRlID0gY3VycmVudFN0YXRlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVkU3RhdGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gKGNoaWxkcmVuLmxlbmd0aCAtIDEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtdXRhdGVkT2JqZWN0ID0ge31cclxuICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleDAgPSAwOyBpbmRleDAgPCBPYmplY3Qua2V5cyhzbmFwc2hvdHNbc25hcHNob3RzLmxlbmd0aCAtIDFdKS5sZW5ndGg7IGluZGV4MCsrKSB7ICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoc25hcHNob3RzW3NuYXBzaG90cy5sZW5ndGggLSAxXSlbaW5kZXgwXSAhPT0gY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoIC0gMV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNuYXBzaG90c1tzbmFwc2hvdHMubGVuZ3RoIC0gMV1bY2hpbGRyZW5baW5kZXhdXSAhPT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdXRhdGVkT2JqZWN0W09iamVjdC5rZXlzKHNuYXBzaG90c1tzbmFwc2hvdHMubGVuZ3RoIC0gMV0pW2luZGV4MF1dID0gc25hcHNob3RzW3NuYXBzaG90cy5sZW5ndGggLSAxXVtPYmplY3Qua2V5cyhzbmFwc2hvdHNbc25hcHNob3RzLmxlbmd0aCAtIDFdKVtpbmRleDBdXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNuYXBzaG90c1tzbmFwc2hvdHMubGVuZ3RoIC0gMV1bY2hpbGRyZW5baW5kZXhdXSA9PT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgVGhlIHJlZmVyZW5jZWQgcHJvcGVydHkgJyR7Y2hpbGRyZW5baW5kZXhdfScgZG9lcyBub3QgZXhpc3QgaW4gY3VycmVudCBzdGF0ZS5gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4MCA9PT0gKE9iamVjdC5rZXlzKHNuYXBzaG90c1tzbmFwc2hvdHMubGVuZ3RoIC0gMV0pLmxlbmd0aCAtIDEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc25hcHNob3RzW3NuYXBzaG90cy5sZW5ndGggLSAxXSA9IG11dGF0ZWRPYmplY3RcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGluZGV4MCA9IHNuYXBzaG90cy5sZW5ndGggLSAxOyBpbmRleDAgPj0gMDsgaW5kZXgwLS0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmRleDAgPCAoc25hcHNob3RzLmxlbmd0aCAtIDEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc25hcHNob3RzW2luZGV4MF1bY2hpbGRyZW5baW5kZXgwICsgMV1dID0gc25hcHNob3RzW2luZGV4MCArIDFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4MCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oY3VycmVudFN0YXRlLCBzdGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN0YXRlW25hbWVGaWVsZF1bY2hpbGRyZW5baW5kZXgwXV0gPSBzbmFwc2hvdHNbaW5kZXgwXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkU3RhdGUgPSBjdXJyZW50U3RhdGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRTdGF0ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc25hcHNob3RzW3NuYXBzaG90cy5sZW5ndGggLSAxXVtjaGlsZHJlbltpbmRleF1dID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBzbmFwc2hvdHNbc25hcHNob3RzLmxlbmd0aCAtIDFdW2NoaWxkcmVuW2luZGV4XV0gIT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuYXBzaG90cy5wdXNoKHNuYXBzaG90c1tzbmFwc2hvdHMubGVuZ3RoIC0gMV1bY2hpbGRyZW5baW5kZXhdXSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc25hcHNob3RzW3NuYXBzaG90cy5sZW5ndGggLSAxXVtjaGlsZHJlbltpbmRleF1dID09PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgVGhlIHJlZmVyZW5jZWQgcHJvcGVydHkgJyR7Y2hpbGRyZW5baW5kZXhdfScgZG9lcyBub3QgZXhpc3QgaW4gY3VycmVudCBzdGF0ZS5gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBUaGUgcmVmZXJlbmNlZCBwcm9wZXJ0eSAnJHtuYW1lRmllbGR9JyBkb2VzIG5vdCBleGlzdCBpbiBjdXJyZW50IHN0YXRlLmApO1xyXG4gICAgICAgICAgICByZXR1cm4gc3RhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG4iXX0= 
